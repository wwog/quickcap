<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>screen</title>
    <script type="module" crossorigin>(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var e=null;function t(){window.app.exit()}async function n(){return e||(e=new Promise((e,t)=>{(async()=>{try{let{width:t,height:n,arrayBuffer:r}=await window.app.getImage();e({imageData:new ImageData(new Uint8ClampedArray(r),t,n),height:n,width:t})}catch(e){t(e)}})()}),e)}const r=({startX:e,startY:t,moveX:n,moveY:r,maxX:i,maxY:a})=>n>=0&&r>=0?{top:t,left:e,width:Math.min(i,n),height:Math.min(a,r)}:n<0&&r>=0?{top:t,left:e+n,width:Math.min(i,-n),height:Math.min(a,r)}:n>=0&&r<0?{top:t+r,left:e,width:Math.min(i,n),height:Math.min(a,-r)}:{top:t+r,left:e+n,width:Math.min(i,-n),height:Math.min(a,-r)},i=({resizeHandle:e,x:t,y:n,width:r,height:i})=>{switch(e){case`resize-top-left`:return{x:t+r,y:n+i};case`resize-top`:case`resize-top-right`:return{x:t,y:n+i};case`resize-right`:case`resize-bottom-right`:case`resize-bottom`:return{x:t,y:n};case`resize-bottom-left`:case`resize-left`:return{x:t+r,y:n};default:return{x:t,y:n}}},a=({resizeHandle:e,fixedX:t,fixedY:n,originWidth:i,originHeight:a,moveX:o,moveY:s,maxX:c,maxY:l})=>{let u=o,d=s;switch(e){case`resize-top-left`:u=o-i,d=s-a;break;case`resize-top`:u=i,d=s-a;break;case`resize-top-right`:u=o+i,d=s-a;break;case`resize-right`:u=o+i,d=a;break;case`resize-bottom-right`:u=o+i,d=s+a;break;case`resize-bottom`:u=i,d=s+a;break;case`resize-bottom-left`:u=o-i,d=s+a;break;case`resize-left`:u=o-i,d=a;break;default:break}return r({startX:t,startY:n,moveX:u,moveY:d,maxX:c,maxY:l})},o=({x:e,y:t,windows:n})=>n.find(n=>e>=n.x&&e<=n.x+n.width&&t>=n.y&&t<=n.y+n.height),s=({x:e,y:t,width:n,height:r})=>{let i=window.innerWidth,a=window.innerHeight,o=Math.min(e+n,i),s=Math.min(t+r,a),c=Math.max(e,0),l=Math.max(t,0);return{x:c,y:l,width:o-c,height:s-l}};function c(){return`${Math.random().toString(36).substring(2,10)}-${Math.random().toString(36).substring(2,10)}-${Math.random().toString(36).substring(2,10)}`}function l(e,t,n,r,i){let a=[],o=n*n,s=Math.max(0,Math.ceil(e-n)),c=Math.min(r,Math.floor(e+n)),l=Math.max(0,Math.ceil(t-n)),u=Math.min(i,Math.floor(t+n));for(let n=l;n<=u;n++){let r=n-t;for(let t=s;t<=c;t++){let i=t-e;i*i+r*r<=o&&a.push({x:t,y:n})}}return a}function u(e,t,n,r,i){let a=[],o=n-e,s=r-t,c=Math.sqrt(o*o+s*s),l=2*i*.5,u=Math.max(2,Math.ceil(c/l));for(let n=0;n<u;n++){let r=n/u,i=e+o*r,c=t+s*r;a.push({x:i,y:c})}return a.push({x:n,y:r}),a}function d(e,{width:t,height:n}){e.width=t*C,e.height=n*C,e.style.width=`${t}px`,e.style.height=`${n}px`;let r=e.getContext(`2d`);r.scale(C,C),r.imageSmoothingEnabled=!0,r.imageSmoothingQuality=`high`}function f({x1:e,y1:t,x2:n,y2:r},{maxX:i,maxY:a}){let o=Math.min(e,n),s=Math.min(Math.max(e,n),i),c=Math.min(t,r),l=Math.min(Math.max(t,r),a),u=s-o,d=l-c;return{centerX:o+u/2,centerY:c+d/2,radiusX:u/2,radiusY:d/2,isCircle:Math.abs(u-d)<2,left:o,top:c,width:u,height:d}}function p({x1:e,y1:t,x2:n,y2:r},{maxX:i,maxY:a}){let o=Math.min(e,n),s=Math.min(Math.max(e,n),i),c=Math.min(t,r),l=Math.min(Math.max(t,r),a);return{x:o,y:c,width:s-o,height:l-c}}function m(e,t){e.strokeStyle=t.pen.color,e.lineWidth=t.pen.lineWidth,e.strokeRect(t.attr.x,t.attr.y,t.attr.width,t.attr.height)}function h(e,t){e.strokeStyle=t.pen.color,e.lineWidth=t.pen.lineWidth;let n=t.attr.centerX,r=t.attr.centerY,i=t.attr.radiusX,a=t.attr.radiusY;e.beginPath(),e.ellipse(n,r,i,a,0,0,Math.PI*2),e.stroke()}function g(e,t){if(console.log(`ðŸš€ ~ drawPath ~ shape.attr.path.length:`,t.attr.path.length),!(t.attr.path.length<2)){e.strokeStyle=t.pen.color,e.lineWidth=t.pen.lineWidth,e.beginPath(),e.moveTo(t.attr.path[0].x,t.attr.path[0].y);for(let n=1;n<t.attr.path.length;n++)e.lineTo(t.attr.path[n].x,t.attr.path[n].y);e.stroke()}}function _(e,t){e.strokeStyle=t.pen.color,e.lineWidth=t.pen.lineWidth;let{fromX:n,fromY:r,toX:i,toY:a}=t.attr;e.beginPath();let o=Math.PI/12,s=Math.atan2(a-r,i-n),c=Math.sqrt((i-n)**2+(a-r)**2);e.moveTo(n,r);let l=Math.min(20,c*.5),u=i-Math.cos(s)*(l-2),d=a-Math.sin(s)*(l-2);e.lineTo(u,d),e.stroke(),e.beginPath(),e.moveTo(i,a);let f=i-l*Math.cos(s-o),p=a-l*Math.sin(s-o),m=i-l*Math.cos(s+o),h=a-l*Math.sin(s+o);e.lineTo(f,p),e.lineTo(m,h),e.closePath(),e.fillStyle=t.pen.color,e.fill()}function v(e,t){switch(t.shape){case`rect`:m(e,t);break;case`circle`:h(e,t);break;case`path`:g(e,t);break;case`arrow`:_(e,t);break}}const y=(e,t)=>{let n=!1,r=!1,i=t=>{(t.target===e||e.contains(t.target))&&(r=!0,n=!1)},a=e=>{r&&!n&&t(e),r=!1,n=!1},o=()=>{r&&(n=!0)},s=()=>{r&&(n=!0)};return document.addEventListener(`mousedown`,i),document.addEventListener(`mousemove`,s),document.addEventListener(`mouseup`,a),document.addEventListener(`mouseleave`,o),()=>{document.removeEventListener(`mousedown`,i),document.removeEventListener(`mousemove`,s),document.removeEventListener(`mouseup`,a),document.removeEventListener(`mouseleave`,o)}},b=(e,t)=>{let n=0;return y(e,e=>{n++,n===2?(t(e),n=0):setTimeout(()=>{n=0},300)})},x=()=>typeof window>`u`?!1:window.navigator.userAgentData?.platform?window.navigator.userAgentData.platform.toLowerCase()===`windows`:window.navigator.userAgent.toLowerCase().includes(`windows`),S=[`resize-top-left`,`resize-top`,`resize-top-right`,`resize-right`,`resize-bottom-right`,`resize-bottom`,`resize-bottom-left`,`resize-left`],C=x()?1:window.devicePixelRatio;var w=10*C,T=class{imageData;drawData;canvas;cache=new Map;width;height;constructor({imgData:e,canvas:t}){this.imageData=e,this.canvas=t,this.width=e.width,this.height=e.height,this.drawData=this.canvas.getContext(`2d`).getImageData(0,0,this.width,this.height)}getMosaicColor({y:e,x:t,cx:n,cy:r,r:i}){let a=Math.floor(t/w),o=Math.floor(e/w),s=`${a},${o}`;if(this.cache.has(s))return this.cache.get(s);let c=a*w,l=o*w,u=Math.min(this.width,c+w),d=Math.min(this.height,l+w),f=i*i,p=this.imageData.data,m=0,h=0,g=0,_=0,v=0;for(let e=l;e<d;e++){let t=e-r,i=t*t;for(let t=c;t<u;t++){let r=t-n;if(r*r+i<=f){let n=(e*this.width+t)*4;m+=p[n],h+=p[n+1],g+=p[n+2],_+=p[n+3],v++}}}let y;return y=v>0?{r:Math.floor(m/v),g:Math.floor(h/v),b:Math.floor(g/v),a:Math.floor(_/v)}:{r:0,g:0,b:0,a:0},this.cache.set(s,y),y}drawMosaicForCircle({cx:e,cy:t,r:n,fresh:r=!1}){l(e*C,t*C,n*C,this.imageData.width,this.imageData.height).forEach(({x:r,y:i})=>{let a=this.getMosaicColor({x:r,y:i,cx:e*C,cy:t*C,r:n*C});a&&(this.drawData.data[i*this.width*4+r*4]=a.r,this.drawData.data[i*this.width*4+r*4+1]=a.g,this.drawData.data[i*this.width*4+r*4+2]=a.b,this.drawData.data[i*this.width*4+r*4+3]=a.a)}),r&&this.canvas.getContext(`2d`).putImageData(this.drawData,0,0)}drawMosaic(e){let{path:t,radius:n}=e.attr;t.forEach(({x:e,y:t})=>{this.drawMosaicForCircle({cx:e,cy:t,r:n})}),this.canvas.getContext(`2d`).putImageData(this.drawData,0,0)}clearMosaic(){this.canvas.getContext(`2d`).clearRect(0,0,this.width,this.height),this.drawData=this.canvas.getContext(`2d`).getImageData(0,0,this.width,this.height)}},E=class{dom;constructor(){this.dom=document.createElement(`div`),this.dom.classList.add(`resize-assist`),this.dom.style.display=`none`,S.forEach(e=>{let t=document.createElement(`div`);t.classList.add(`resize-assist-handle`,e),t.dataset.role=e,this.dom.appendChild(t)}),document.body.appendChild(this.dom)}show(){this.dom.style.display=`block`}hide(){this.dom.style.display=`none`}setPosition({top:e,left:t,width:n,height:r}){this.dom.style.top=`${e}px`,this.dom.style.left=`${t}px`,this.dom.style.width=`${n}px`,this.dom.style.height=`${r}px`}},D=class{lastImg=null;baseCanvas;mosaicCanvas;editCanvas;baseCtx;mosaicCtx;editCtx;mosaic=null;_mode=`normal`;resizeAssist;drawState=null;shapeArr=[];currentDrawPos={x1:0,y1:0,x2:0,y2:0};drawing=!1;get mode(){return this._mode}set mode(e){this._mode!==e&&(this._mode=e)}constructor(){this.baseCanvas=document.createElement(`canvas`),this.mosaicCanvas=document.createElement(`canvas`),this.editCanvas=document.createElement(`canvas`),this.baseCtx=this.baseCanvas.getContext(`2d`),this.mosaicCtx=this.mosaicCanvas.getContext(`2d`),this.editCtx=this.editCanvas.getContext(`2d`),this.baseCanvas.style.position=`absolute`,this.mosaicCanvas.style.position=`absolute`,this.editCanvas.style.position=`absolute`,this.baseCanvas.style.top=`0px`,this.baseCanvas.style.left=`0px`,this.mosaicCanvas.style.top=`0px`,this.mosaicCanvas.style.left=`0px`,this.editCanvas.style.left=`0px`,this.editCanvas.style.left=`0px`,this.resizeAssist=new E,console.log(`editCanvas created`,this.resizeAssist),window.editCanvas=this}getCanvasPos=(e,t)=>this.lastImg?{x:Math.min(Math.max(e-this.lastImg.x,0),this.lastImg.x+this.lastImg.width),y:Math.min(Math.max(t-this.lastImg.y,0),this.lastImg.y+this.lastImg.height)}:{x:0,y:0};initListener=()=>{this.editCanvas.addEventListener(`mousedown`,e=>{if(this.mode===`normal`)return;let{x:t,y:n}=this.getCanvasPos(e.clientX,e.clientY);this.currentDrawPos={x1:t,y1:n,x2:t,y2:n},this.drawing=!0}),document.body.addEventListener(`mousemove`,e=>{if(this.mode!==`normal`&&this.drawing){let{x:t,y:n}=this.getCanvasPos(e.clientX,e.clientY);switch(this.currentDrawPos.x2=t,this.currentDrawPos.y2=n,this.drawState?.shape){case`rect`:let e=p(this.currentDrawPos,{maxX:this.lastImg.width,maxY:this.lastImg.height});this.drawState.attr=e,this.renderAll();break;case`circle`:let r=f(this.currentDrawPos,{maxX:this.lastImg.width,maxY:this.lastImg.height});this.drawState.attr=r,this.renderAll();break;case`path`:this.drawState.attr.path.length||this.drawState.attr.path.push({x:this.currentDrawPos.x1,y:this.currentDrawPos.y1}),this.drawState.attr.path.push({x:t,y:n}),this.renderPreview();break;case`mosaic`:if(console.log(`%cðŸŽ„ mosaic`,`background-color: #00b548; color: #fff;padding: 2px 4px;border-radius: 2px;`,t,n,this.mosaic),!this.drawState.attr.path.length)this.drawState.attr.path.push({x:this.currentDrawPos.x1,y:this.currentDrawPos.y1}),this.mosaic?.drawMosaicForCircle({cx:this.currentDrawPos.x1,cy:this.currentDrawPos.y1,r:this.drawState.attr.radius,fresh:!0});else{let e=this.drawState.attr.path[this.drawState.attr.path.length-1],r=u(e.x,e.y,t,n,this.drawState.attr.radius);for(let e=1;e<r.length;e++){let t=r[e];this.drawState.attr.path.push({x:t.x,y:t.y}),this.mosaic?.drawMosaicForCircle({cx:t.x,cy:t.y,r:this.drawState.attr.radius,fresh:!0})}}break;case`arrow`:this.drawState.attr={fromX:this.currentDrawPos.x1,fromY:this.currentDrawPos.y1,toX:this.currentDrawPos.x2,toY:this.currentDrawPos.y2},this.renderAll();break;default:break}}}),document.body.addEventListener(`mouseup`,e=>{console.log(`ðŸš€ ~ EditCanvas ~ e:`,e),this.mode!==`normal`&&this.drawing&&this.drawState&&(this.drawing=!1,(this.currentDrawPos.x1!==this.currentDrawPos.x2||this.currentDrawPos.y1!==this.currentDrawPos.y2)&&(e.preventDefault(),e.stopPropagation(),this.shapeArr.push(this.drawState),this.setShape(this.drawState.shape)))})};initCanvasSetting(e,t){d(this.baseCanvas,{width:e,height:t}),d(this.mosaicCanvas,{width:e,height:t}),d(this.editCanvas,{width:e,height:t})}setParentDom(e){e.appendChild(this.baseCanvas),e.appendChild(this.mosaicCanvas),e.appendChild(this.editCanvas)}setMode(e){this.mode=e}getCtx(){return this.editCtx}async generateImageData(){this.baseCtx.drawImage(this.mosaicCanvas,0,0,this.mosaicCanvas.width,this.mosaicCanvas.height,0,0,this.lastImg.width,this.lastImg.height),this.baseCtx.drawImage(this.editCanvas,0,0,this.editCanvas.width,this.editCanvas.height,0,0,this.lastImg.width,this.lastImg.height);let e=this.baseCtx.getImageData(0,0,this.lastImg.width*C,this.lastImg.height*C);return Promise.resolve(e)}writeToClipboard=async()=>{console.log(`writeToClipboard`);let e=await this.generateImageData();await window.app.copyToClipboard(e),window.app.exit()};saveImageToFolder=async()=>{console.log(`saveImageToFolder`);let e=await this.generateImageData();(await window.app.saveImageToFolder(e)).status===201||window.app.exit()};setImg({img:e,x:t=0,y:n=0,width:r,height:i}){if(this.lastImg&&this.lastImg.x===t&&this.lastImg.y===n&&this.lastImg.width===r&&this.lastImg.height===i)return;let a=performance.now(),o=e.getContext(`2d`).getImageData(t*C,n*C,r*C,i*C);this.baseCtx.putImageData(o,0,0);let s=performance.now();console.log(`drawImage cost ${s-a} ms`),this.lastImg={x:t,y:n,width:r,height:i},this.initListener(),this.mosaic=new T({imgData:o,canvas:this.mosaicCanvas})}setShape(e=`rect`){switch(e){case`rect`:this.drawState={id:c(),shape:`rect`,attr:{x:0,y:0,width:0,height:0},pen:{color:`#ff0000`,lineWidth:2}};break;case`circle`:this.drawState={id:c(),shape:`circle`,attr:{centerX:0,centerY:0,radiusX:0,radiusY:0,isCircle:!1,left:0,top:0,width:0,height:0},pen:{color:`#ff0000`,lineWidth:2}};break;case`path`:this.drawState={id:c(),shape:`path`,attr:{path:[]},pen:{color:`#ff0000`,lineWidth:2}};break;case`mosaic`:this.drawState={id:c(),shape:`mosaic`,attr:{path:[],radius:10}};break;case`arrow`:this.drawState={id:c(),shape:`arrow`,attr:{fromX:0,fromY:0,toX:0,toY:0},pen:{color:`#ff0000`,lineWidth:2}};break;default:this.drawState=null;break}}renderAll=()=>{this.editCtx.clearRect(0,0,this.editCanvas.width,this.editCanvas.height),this.shapeArr.forEach(e=>{v(this.editCtx,e)}),this.renderPreview()};renderPreview=()=>{this.currentDrawPos.x1===this.currentDrawPos.x2&&this.currentDrawPos.y1===this.currentDrawPos.y2||this.drawState&&v(this.editCtx,this.drawState)}};const O=[{id:`rect`,className:`box-select rect`,content:`<div style="width: 70%; height: 70%; border-radius: 4px; border: 2px solid #D8D8D8;"></div>`,role:`edit`,shape:`rect`},{id:`circle`,className:`box-select circle`,content:`<div style="width: 70%; height: 70%; border-radius: 50%; border: 2px solid #D8D8D8;"></div>`,role:`edit`,shape:`circle`},{id:`arrow`,className:`box-select arrow`,content:`<div style="width: 70%; height: 70%; position: relative;">
      <div style="width:100%; height: 2px; background-color: #D8D8D8; position: absolute; top: 50%; left: 0; transform: translateY(-50%) rotate(-215deg);">
        <div style="width: 10px; height: 2px; background-color: #D8D8D8; position: absolute; right: 0; top: 0; transform: rotate(45deg); transform-origin: right center;"></div>
        <div style="width: 10px; height: 2px; background-color: #D8D8D8; position: absolute; right: 0; top: 0; transform: rotate(-45deg); transform-origin: right center;"></div>
      </div>
    </div>`,role:`edit`,shape:`arrow`},{id:`path`,className:`box-select path`,content:`<div style="width: 70%; height: 70%; position: relative;">
      <div style="width:100%; height: 2px; background-color: #D8D8D8; position: absolute; top: 50%; left: 0; transform: translateY(-50%) rotate(-215deg);">
      </div>
    </div>`,role:`edit`,shape:`path`},{id:`mosaic`,className:`box-select mosaic`,content:`<div style="width: 70%; height: 70%; position: relative; display: flex; flex-wrap: wrap;">
      <div style="width: 50%; height: 50%; background-color: #D8D8D8; opacity: 0.5;"></div>
      <div style="width: 50%; height: 50%; background-color: #D8D8D8; opacity: 1;"></div>
      <div style="width: 50%; height: 50%; background-color: #D8D8D8; opacity: 1;"></div>
      <div style="width: 50%; height: 50%; background-color: #D8D8D8; opacity:0.51;"></div>
    </div>`,role:`edit`,shape:`mosaic`},{id:`download`,className:`download`,content:`<svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect opacity="0" width="48" height="48" fill="#D8D8D8"/>
<path fill-rule="evenodd" clip-rule="evenodd" d="M24.0416 2C21.8325 2 20.0416 3.79086 20.0416 6V31.8258L12.7749 24.217C11.2251 22.5943 8.71225 22.5943 7.16239 24.217C5.61254 25.8396 5.61254 28.4704 7.16239 30.093L20.897 44.4724C21.2958 44.979 21.8145 45.3869 22.4103 45.6533C22.9221 45.8873 23.4715 46.0029 24.0205 45.9999C24.0275 46 24.0346 46 24.0416 46C25.4652 46 26.7151 45.2564 27.424 44.1363L40.8376 30.093C42.3875 28.4704 42.3875 25.8396 40.8376 24.217C39.2877 22.5943 36.7749 22.5943 35.2251 24.217L28.0416 31.7367V6C28.0416 3.79086 26.2508 2 24.0416 2Z" fill="#A2A8C3"/>
</svg>`,role:`download`},{id:`cancel`,className:`cancel`,content:`<svg
          width="30"
          height="30"
          viewBox="0 0 30 30"
          fill="red"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M0.596608 0.596608C1.39209 -0.198869 2.68181 -0.198869 3.47729 0.596608L14.9993 12.1186L26.5227 0.596608C27.3182 -0.198869 28.6079 -0.198869 29.4034 0.596608C30.1989 1.39209 30.1989 2.68181 29.4034 3.47729L17.88 14.9993L29.4034 26.5227C30.1989 27.3182 30.1989 28.6079 29.4034 29.4034C28.6079 30.1989 27.3182 30.1989 26.5227 29.4034L14.9993 17.88L3.47729 29.4034C2.68181 30.1989 1.39209 30.1989 0.596608 29.4034C-0.198869 28.6079 -0.198869 27.3182 0.596608 26.5227L12.1186 14.9993L0.596608 3.47729C-0.198869 2.68181 -0.198869 1.39209 0.596608 0.596608Z"
            fill="red"
          />
        </svg>`,role:`cancel`},{id:`finish`,className:`finish`,content:`<svg
          width="29"
          height="24"
          viewBox="0 0 29 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M2 14.3611L9.72055 22L26.4444 2"
            stroke="#00C6DB"
            stroke-width="4"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>`,role:`finish`}];var k=class{dom;itemListeners=new Map;_active=``;get active(){return this._active}set active(e){this.dom.querySelector(`.edit-tool-item.active`)?.classList.remove(`active`),e&&this.dom.querySelector(`.edit-tool-item[data-shape="${e}"]`)?.classList.add(`active`),this._active=e}constructor(e){this.dom=document.createElement(`div`),this.dom.classList.add(`edit-tool`),this.dom.style.visibility=`hidden`;let t=e||document.body;t&&t.appendChild(this.dom),this.initItems(),this.initListeners()}initItems=()=>{O.forEach(e=>{let t=document.createElement(`div`);t.classList.add(`edit-tool-item`,...e.className.split(` `)),t.innerHTML=e.content||``,t.dataset.role=e.role||``,t.dataset.shape=e.shape||``,this.dom.appendChild(t)})};initListeners=()=>{this.dom.addEventListener(`click`,e=>{let t=e.target;for(;t&&!t.classList.contains(`edit-tool-item`)&&(t=t.parentElement,t!==this.dom););if(!t)return;let n=t.dataset.role||``,r=t.dataset.shape||void 0,i=this.itemListeners.get(n);i&&i(r)})};addListener=e=>{e.forEach(e=>{this.itemListeners.set(e.role,e.listener)})};render=(e=!0,{x:t,y:n,height:r,width:i})=>{if(!e){this.dom.style.visibility=`hidden`;return}if(this.dom){this.dom.style.visibility=`visible`,this.dom.style.left=`${t+i-this.dom.clientWidth}px`;let e=window.innerHeight;if(n+r+32+8<=e){this.dom.style.top=`${n+r+8}px`;return}if(n-32-8>=0){this.dom.style.top=`${n-32-8}px`;return}this.dom.style.top=`${n+r-32-8}px`}}},A=class{dom;constructor(e){this.dom=document.createElement(`div`),this.dom.classList.add(`size-display`),e.appendChild(this.dom)}render=(e=!0,{x:t,y:n,height:r,width:i})=>{if(!e||!r&&!i){this.dom.style.visibility=`hidden`;return}this.dom.style.visibility=`visible`,this.dom.style.left=`${t}px`,n-20-8<0?this.dom.style.top=`${n+8}px`:this.dom.style.top=`${n-20-8}px`,this.dom.innerText=`${i*C} x ${r*C}`}},j=class{sizeDisplay;editTools;editCanvas;imgDom;canvasContainer=document.createElement(`div`);baseCanvas=document.createElement(`canvas`);maskCanvas=document.createElement(`canvas`);baseCtx;maskCtx;selectRectDom;isSelecting=!1;resizeHandle=``;startX=0;startY=0;fixedX=0;fixedY=0;fixedWidth=0;fixedHeight=0;selectX=0;selectY=0;selectWidth=0;selectHeight=0;broadcastChannel=new BroadcastChannel(`broadcast`);id=Math.random().toString(36).substring(2);matchedWindow=void 0;_mode=`select`;get mode(){return this._mode}set mode(e){if(this._mode!==e)switch(this._mode=e,e){case`waitEdit`:this.canvasContainer.style.cursor=``,this.selectRectDom.style.cursor=`move`;break;case`move`:this.canvasContainer.style.cursor=`move`;break;case`edit`:this.canvasContainer.style.cursor=``,this.selectRectDom.style.cursor=`crosshair`,this.canvasContainer.classList.add(`edit-mode`),this.broadcastChannel.postMessage({type:`startEdit`,id:this.id});break;case`forbidden`:case`otherTab`:this.selectX=0,this.selectY=0,this.selectWidth=0,this.selectHeight=0,this.drawMask(),this.editTools.render(!1,{x:0,y:0,height:0,width:0}),this.sizeDisplay.render(!1,{x:0,y:0,height:0,width:0});break}}imgNaturalWidth=0;imgNaturalHeight=0;imgDrawWidth=0;imgDrawHeight=0;boxWidth=0;boxHeight=0;imgOffsetX=0;imgOffsetY=0;windows=[];constructor(e){this.imgDom=null,this.canvasContainer.classList.add(`canvas-container`),this.maskCanvas.classList.add(`mask-canvas`),this.maskCtx=this.maskCanvas.getContext(`2d`),this.baseCtx=this.baseCanvas.getContext(`2d`),this.editCanvas=new D,this.selectRectDom=document.createElement(`div`),this.selectRectDom.classList.add(`select-rect`),e.appendChild(this.canvasContainer),this.canvasContainer.appendChild(this.baseCanvas),this.canvasContainer.appendChild(this.maskCanvas),S.forEach(e=>{let t=document.createElement(`div`);t.classList.add(`resize-handle`,e),t.dataset.role=e,this.selectRectDom.appendChild(t)}),this.initData(),this.drawMask(),this.initListener(),this.sizeDisplay=new A(this.canvasContainer),this.editTools=new k,this.editTools.addListener([{role:`edit`,listener:e=>{this.setEditCanvasBg(),this.editCanvas.setMode(`edit`);let t=e===this.editTools.active?``:e||``;this.editCanvas.setShape(t),this.editTools.active=t}},{role:`download`,listener:()=>{this.setEditCanvasBg(),this.editCanvas.saveImageToFolder()}},{role:`finish`,listener:()=>{this.setEditCanvasBg(),this.editCanvas.writeToClipboard()}},{role:`cancel`,listener:()=>{t()}}]),window.app?.getWindows?.().then(e=>{let t=window.innerWidth,n=window.innerHeight,r=[];e.forEach(e=>{if(e.name!==`tao window`){let{x:t,y:n,width:i,height:a}=e.bounds;r.push(s({x:t,y:n,width:i,height:a}))}}),r.push({x:0,y:0,width:t,height:n}),this.windows=r}).catch(e=>console.error(e)),this.broadcastChannel.onmessage=e=>{let{type:t,id:n,x:r,y:i}=e?.data||{};t===`activeWindow`&&n!==this.id?this.mode=`otherTab`:t===`activeWindow`&&n===this.id&&this.mode===`otherTab`?this.mode=`select`:t===`startEdit`&&n&&n!==this.id&&(this.mode=`forbidden`)}}setImgDom=e=>{this.imgDom=e,this.imgNaturalWidth=this.imgDom.naturalWidth,this.imgNaturalHeight=this.imgDom.naturalHeight;let t=this.imgNaturalWidth/this.boxWidth,n=this.imgNaturalHeight/this.boxHeight,r=Math.max(t,n);this.imgDrawWidth=this.imgNaturalWidth/r,this.imgDrawHeight=this.imgNaturalHeight/r,this.imgOffsetX=(this.boxWidth-this.imgDrawWidth)/2,this.imgOffsetY=(this.boxHeight-this.imgDrawHeight)/2,this.drawBase()};setEditCanvasBg=()=>{this.mode!==`edit`&&(this.mode=`edit`,this.editCanvas.initCanvasSetting(this.selectWidth,this.selectHeight),this.editCanvas.setParentDom(this.selectRectDom),this.editCanvas.setImg({img:this.baseCanvas,x:this.selectX,y:this.selectY,width:this.selectWidth,height:this.selectHeight}))};drawBase=()=>{if(!this.imgDom){console.error(`Image dom is not set`);return}this.baseCtx.drawImage(this.imgDom,0,0,this.imgNaturalWidth,this.imgNaturalHeight,this.imgOffsetX,this.imgOffsetY,this.imgDrawWidth,this.imgDrawHeight)};initData=()=>{this.boxWidth=this.canvasContainer.clientWidth,this.boxHeight=this.canvasContainer.clientHeight,d(this.maskCanvas,{width:this.boxWidth,height:this.boxHeight}),d(this.baseCanvas,{width:this.boxWidth,height:this.boxHeight})};activeWindow=e=>{if(this.broadcastChannel.postMessage({type:`activeWindow`,id:this.id,x:e.clientX,y:e.clientY}),this.mode===`otherTab`){this.mode=`select`;return}};drawMask=()=>{this.maskCtx.clearRect(0,0,this.boxWidth,this.boxHeight),this.maskCtx.fillStyle=`rgba(0, 0, 0, 0.5)`,this.maskCtx.fillRect(0,0,this.boxWidth,this.boxHeight),this.selectWidth&&this.selectHeight?(this.maskCtx.clearRect(this.selectX,this.selectY,this.selectWidth,this.selectHeight),this.canvasContainer.appendChild(this.selectRectDom),this.selectRectDom.style.left=`${this.selectX-1}px`,this.selectRectDom.style.top=`${this.selectY-1}px`,this.selectRectDom.style.width=`${this.selectWidth}px`,this.selectRectDom.style.height=`${this.selectHeight}px`):this.selectRectDom.remove()};selectStart=e=>{this.mode===`select`&&(this.isSelecting=!0,this.startX=e.clientX,this.startY=e.clientY,console.log(`%cðŸŽ„ select start`,`background-color: #00b548; color: #fff;padding: 2px 4px;border-radius: 2px;`,this.startX,this.startY))};selectMove=e=>{if(this.mode!==`select`)return;if(!this.isSelecting){let t=o({x:e.clientX,y:e.clientY,windows:this.windows});if(this.matchedWindow=t,!t){this.matchedWindow=void 0;return}this.selectX=t.x,this.selectY=t.y,this.selectWidth=t.width,this.selectHeight=t.height,this.drawMask();return}let{top:t,left:n,width:i,height:a}=r({startX:this.startX,startY:this.startY,moveX:e.clientX-this.startX,moveY:e.clientY-this.startY,maxX:this.boxWidth,maxY:this.boxHeight});this.selectX=n,this.selectY=t,this.selectWidth=i,this.selectHeight=a,this.drawMask()};selectEnd=()=>{this.mode===`select`&&(this.isSelecting=!1,this.mode=`waitEdit`)};resizeStart=e=>{if(this.mode!==`select`)if(e.target?.classList?.contains(`resize-handle`)){this.resizeHandle=e.target.dataset.role||``,this.mode=`resizing`;let t=getComputedStyle(e.target).cursor||``;this.canvasContainer.style.cursor=t,this.selectRectDom.style.cursor=t,this.startX=e.clientX,this.startY=e.clientY;let{x:n,y:r}=i({resizeHandle:this.resizeHandle,x:this.selectX,y:this.selectY,width:this.selectWidth,height:this.selectHeight});this.fixedX=n,this.fixedY=r,this.fixedWidth=this.selectWidth,this.fixedHeight=this.selectHeight}else e.target?.classList?.contains(`select-rect`)&&(this.mode=`move`,this.startX=e.clientX,this.startY=e.clientY,this.fixedX=this.selectX,this.fixedY=this.selectY,this.fixedWidth=this.selectWidth,this.fixedHeight=this.selectHeight)};resizeMove=e=>{if(this.mode!==`select`){if(this.mode===`resizing`&&this.resizeHandle){let{top:t,left:n,width:r,height:i}=a({resizeHandle:this.resizeHandle,fixedX:this.fixedX,fixedY:this.fixedY,originWidth:this.fixedWidth,originHeight:this.fixedHeight,moveX:e.clientX-this.startX,moveY:e.clientY-this.startY,maxX:this.boxWidth,maxY:this.boxHeight});this.selectX=n,this.selectY=t,this.selectWidth=r,this.selectHeight=i,this.drawMask()}else if(this.mode===`move`){let t=e.clientX-this.startX,n=e.clientY-this.startY,r=this.fixedX+t,i=this.fixedY+n;(r<0||r+this.fixedWidth>this.boxWidth)&&(this.fixedX=this.selectX,this.fixedWidth=this.selectWidth,this.startX=e.clientX),(i<0||i+this.fixedHeight>this.boxHeight)&&(this.fixedY=this.selectY,this.fixedHeight=this.selectHeight,this.startY=e.clientY),r<0?r=0:r+this.fixedWidth>this.boxWidth&&(r=this.boxWidth-this.fixedWidth),i<0?i=0:i+this.fixedHeight>this.boxHeight&&(i=this.boxHeight-this.fixedHeight),this.selectX=r,this.selectY=i,this.drawMask()}}};resizeEnd=()=>{this.mode!==`select`&&(this.mode=`waitEdit`,this.resizeHandle=``)};onMouseDown=e=>{if(console.log(`%cðŸŽ„ mouse down`,`background-color: #00b548; color: #fff;padding: 2px 4px;border-radius: 2px;`,this.mode,e.clientX,e.clientY),this.mode===`edit`||this.mode===`forbidden`||(this.activeWindow(e),this.mode===`otherTab`))return;let t=e.target===this.selectRectDom||this.selectRectDom.contains(e.target);this.editTools.render(this.mode===`waitEdit`&&!t,{x:this.selectX,y:this.selectY,width:this.selectWidth,height:this.selectHeight}),this.mode===`select`?this.selectStart(e):this.resizeStart(e)};onMouseMove=e=>{console.log(`%cðŸŽ„ mouse move`,`background-color: #00b548; color: #fff;padding: 2px 4px;border-radius: 2px;`,this.mode,e.clientX,e.clientY),!(this.mode===`edit`||this.mode===`forbidden`)&&(this.activeWindow(e),this.mode!==`otherTab`&&(this.mode===`select`?(this.selectMove(e),this.sizeDisplay.render(!0,{x:this.selectX,y:this.selectY,width:this.selectWidth,height:this.selectHeight})):(this.resizeMove(e),this.sizeDisplay.render(!0,{x:this.selectX,y:this.selectY,width:this.selectWidth,height:this.selectHeight}))))};onMouseUp=e=>{if(console.log(`%cðŸŽ„ mouse up`,`background-color: #00b548; color: #fff;padding: 2px 4px;border-radius: 2px;`,this.mode,this.startX,this.startY,e.clientX,e.clientY,this.selectWidth,this.selectHeight),!(this.mode===`edit`||this.mode===`forbidden`)&&(this.activeWindow(e),this.mode!==`otherTab`))switch(this.mode){case`select`:e.stopPropagation(),e.preventDefault(),this.selectWidth&&this.selectHeight?(this.selectEnd(),this.editTools.render(!0,{x:this.selectX,y:this.selectY,width:this.selectWidth,height:this.selectHeight}),this.drawMask()):(this.matchedWindow&&(this.selectX=this.matchedWindow.x,this.selectY=this.matchedWindow.y,this.selectWidth=this.matchedWindow.width,this.selectHeight=this.matchedWindow.height),this.drawMask(),this.isSelecting=!1);break;case`waitEdit`:case`move`:case`resizing`:e.stopPropagation(),e.preventDefault(),this.resizeEnd(),this.editTools.render(!0,{x:this.selectX,y:this.selectY,width:this.selectWidth,height:this.selectHeight});break;default:break}};onMouseLeave=e=>{if(this.mode===`move`){let t=e.clientX,n=e.clientY;t>this.boxWidth?this.selectX=this.boxWidth-this.selectWidth:t<0&&(this.selectX=0),n>this.boxHeight?this.selectY=this.boxHeight-this.selectHeight:n<0&&(this.selectY=0),this.fixedX=this.selectX,this.fixedY=this.selectY,this.fixedWidth=this.selectWidth,this.fixedHeight=this.selectHeight,this.startX=e.clientX,this.startY=e.clientY,this.drawMask()}};onMouseEnter=e=>{this.mode===`edit`||this.mode===`forbidden`||this.activeWindow(e)};initListener=()=>{document.body.addEventListener(`mousedown`,this.onMouseDown),document.body.addEventListener(`mousemove`,this.onMouseMove),document.body.addEventListener(`mouseup`,this.onMouseUp),document.body.addEventListener(`mouseleave`,this.onMouseLeave),document.body.addEventListener(`mouseenter`,this.onMouseEnter),b(this.selectRectDom,()=>{console.log(`================double click================`),this.setEditCanvasBg(),this.editCanvas.writeToClipboard()})};putImageData=({imageData:e,width:t,height:n})=>{this.imgNaturalWidth=t,this.imgNaturalHeight=n;let r=this.imgNaturalWidth/this.boxWidth,i=this.imgNaturalHeight/this.boxHeight,a=Math.max(r,i);this.imgDrawWidth=this.imgNaturalWidth/a,this.imgDrawHeight=this.imgNaturalHeight/a,this.imgOffsetX=(this.boxWidth-this.imgDrawWidth)/2,this.imgOffsetY=(this.boxHeight-this.imgDrawHeight)/2,this.baseCtx.putImageData(e,0,0)}},M=document.querySelector(`#app`);function N(){console.log(`Environment mode:`,`production`),console.log(`Is development:`,!1),console.log(`Is production:`,!0);let e=new j(M);console.log(`ðŸš€ ~ init ~ drawScreen:`,e),window.drawScreen=e,n().then(t=>{e.putImageData(t)}).catch(e=>console.error(e)),window.addEventListener(`keydown`,e=>{e.key===`Escape`&&t()})}N();</script>
    <style rel="stylesheet" crossorigin>:root{color:#ffffffde;font-synthesis:none;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;--resize-handle-size:5px;font-family:system-ui,Avenir,Helvetica,Arial,sans-serif;font-weight:400;line-height:1.5}*{box-sizing:border-box;-webkit-user-select:none;user-select:none;margin:0;padding:0}html,body{-webkit-user-select:none;user-select:none;background-color:#0000;width:100%;height:100%;overflow:hidden}#app{-webkit-user-select:none;user-select:none;background-color:#0000;width:100%;height:100%;position:relative}#app img{-o-object-fit:contain;object-fit:contain;max-width:100%;max-height:100%}.canvas-container{z-index:100;-webkit-user-select:none;user-select:none;width:100%;height:100%;position:absolute;top:0;left:0;overflow:hidden}canvas{-webkit-user-select:none;user-select:none;image-rendering:-webkit-optimize-contrast;image-rendering:crisp-edges;image-rendering:pixelated;display:block}.mask-canvas{z-index:200;width:100%;height:100%;position:absolute;top:0;left:0}.select-rect{z-index:300;box-sizing:content-box;border:1px solid #adff2f;position:absolute;transform:translate(0,0)}.resize-handle{width:var(--resize-handle-size);height:var(--resize-handle-size);-webkit-user-select:none;user-select:none;background-color:#adff2f;position:absolute}.resize-top-left{top:calc(var(--resize-handle-size)/-2);left:calc(var(--resize-handle-size)/-2);cursor:nwse-resize}.resize-top{top:calc(var(--resize-handle-size)/-2);cursor:ns-resize;left:50%;transform:translate(-50%)}.resize-top-right{top:calc(var(--resize-handle-size)/-2);right:calc(var(--resize-handle-size)/-2);cursor:nesw-resize}.resize-right{right:calc(var(--resize-handle-size)/-2);cursor:ew-resize;top:50%;transform:translateY(-50%)}.resize-bottom-right{right:calc(var(--resize-handle-size)/-2);bottom:calc(var(--resize-handle-size)/-2);cursor:nwse-resize}.resize-bottom{bottom:calc(var(--resize-handle-size)/-2);cursor:ns-resize;left:50%;transform:translate(-50%)}.resize-bottom-left{bottom:calc(var(--resize-handle-size)/-2);left:calc(var(--resize-handle-size)/-2);cursor:nesw-resize}.resize-left{top:50%;left:calc(var(--resize-handle-size)/-2);cursor:ew-resize;transform:translateY(-50%)}.edit-mode .resize-handle{cursor:default}.resize-assist{z-index:400;border:1px dashed #00000080;position:absolute}.resize-assist-handle{width:var(--resize-handle-size);height:var(--resize-handle-size);background-color:#ffffff80;border-radius:50%;position:absolute}.edit-tool{-webkit-user-select:none;user-select:none;z-index:400;visibility:hidden;background-color:#fff;border-radius:8px;justify-content:center;align-items:center;gap:8px;width:fit-content;height:32px;padding:0 8px;display:flex;position:absolute;bottom:0;right:0;box-shadow:0 2px 8px #00000026}.edit-tool-item{-webkit-user-select:none;user-select:none;cursor:pointer;color:#000;border-radius:8px;justify-content:center;align-items:center;width:28px;height:28px;display:flex}.edit-tool-item.active{background-color:#f5f5f5}.edit-tool-item svg{-webkit-user-select:none;user-select:none}.edit-tool-item:hover{background-color:#f5f5f5}.download svg{width:18px;height:18px}.finish svg,.cancel svg{width:16px;height:16px}.size-display{-webkit-user-select:none;user-select:none;z-index:400;color:#fff;visibility:hidden;justify-content:center;align-items:center;gap:2px;width:fit-content;height:20px;padding:0 2px;display:flex;position:absolute;bottom:0;left:0}
/*$vite$:1*/</style>
  </head>
  <body>
    <div id="app"></div>
  </body>
</html>
