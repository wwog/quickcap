name: Build and Release

on:
  push:
    tags:
      - 'v*'  # 匹配版本标签，如 v0.1.0, v1.2.3

env:
  CARGO_TERM_COLOR: always
  MACOSX_DEPLOYMENT_TARGET: "12.3"

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            artifact_name: Windows-x64
            artifact_ext: .exe
          - target: x86_64-apple-darwin
            os: macos-latest  # GitHub Actions macOS runner 是 ARM，但支持 Rosetta 2
            artifact_name: macOS-Intel
            artifact_ext: ""
          - target: aarch64-apple-darwin
            os: macos-latest
            artifact_name: macOS-ARM
            artifact_ext: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-

      - name: Set up macOS x86_64 cross-compilation
        if: matrix.target == 'x86_64-apple-darwin' && runner.os == 'macOS'
        run: |
          echo "设置 x86_64 macOS 交叉编译环境..."
          echo "当前架构: $(uname -m)"
          
          # 设置环境变量
          echo "ARCHS=x86_64" >> $GITHUB_ENV
          echo "ARCH=x86_64" >> $GITHUB_ENV
          echo "TARGET_ARCH=x86_64" >> $GITHUB_ENV
          echo "SWIFT_TARGET_TRIPLE=x86_64-apple-macosx12.3" >> $GITHUB_ENV
          echo "CC_x86_64_apple_darwin=clang -arch x86_64 -mmacosx-version-min=12.3" >> $GITHUB_ENV
          echo "CXX_x86_64_apple_darwin=clang++ -arch x86_64 -mmacosx-version-min=12.3" >> $GITHUB_ENV
          echo "SWIFTFLAGS=-target x86_64-apple-macosx12.3" >> $GITHUB_ENV
          
          # 清理可能存在的错误架构构建缓存
          if [ -d "target/x86_64-apple-darwin" ]; then
            echo "清理 x86_64 构建缓存..."
            find target/x86_64-apple-darwin -path "*/capscreen_macos-*/out" -type d -exec rm -rf {} + 2>/dev/null || true
            find target/x86_64-apple-darwin -name "*.swift.o" -type f -delete 2>/dev/null || true
          fi

      - name: Build
        shell: bash
        run: |
          if [ "${{ matrix.target }}" == "x86_64-apple-darwin" ] && [ "$(uname -m)" == "arm64" ]; then
            echo "在 ARM Mac 上构建 x86_64，使用 Rosetta 2..."
            arch -x86_64 cargo build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi
        env:
          MACOSX_DEPLOYMENT_TARGET: "12.3"

      - name: Get build info
        id: build_info
        run: |
          BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          BUILD_COMMIT=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +"%Y-%m-%d")
          echo "time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "commit=$BUILD_COMMIT" >> $GITHUB_OUTPUT
          echo "date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "target=${{ matrix.target }}" >> $GITHUB_OUTPUT
          echo "artifact=${{ matrix.artifact_name }}" >> $GITHUB_OUTPUT

      - name: Prepare artifact
        shell: bash
        run: |
          mkdir -p dist/${{ matrix.artifact_name }}
          if [ "${{ runner.os }}" == "Windows" ]; then
            cp target/${{ matrix.target }}/release/quickcap.exe dist/${{ matrix.artifact_name }}/quickcap.exe
          else
            cp target/${{ matrix.target }}/release/quickcap dist/${{ matrix.artifact_name }}/quickcap
            # 为 macOS 可执行文件添加执行权限
            chmod +x dist/${{ matrix.artifact_name }}/quickcap
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.artifact_name }}/
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version tag
        id: tag
        run: |
          VERSION_TAG=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION_TAG#v}
          echo "tag=$VERSION_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get build information
        id: build_info
        run: |
          BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          BUILD_DATE=$(date -u +"%Y-%m-%d")
          BUILD_COMMIT=$(git rev-parse --short HEAD)
          echo "time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "commit=$BUILD_COMMIT" >> $GITHUB_OUTPUT

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # Windows
          if [ -d "artifacts/Windows-x64" ] && [ -f "artifacts/Windows-x64/quickcap.exe" ]; then
            cp artifacts/Windows-x64/quickcap.exe release-assets/quickcap-windows-x64.exe
            cd release-assets
            zip quickcap-windows-x64.zip quickcap-windows-x64.exe
            cd ..
          fi
          
          # macOS Intel
          if [ -d "artifacts/macOS-Intel" ] && [ -f "artifacts/macOS-Intel/quickcap" ]; then
            cp artifacts/macOS-Intel/quickcap release-assets/quickcap-macos-intel
            chmod +x release-assets/quickcap-macos-intel
            cd release-assets
            tar -czf quickcap-macos-intel.tar.gz quickcap-macos-intel
            cd ..
          fi
          
          # macOS ARM
          if [ -d "artifacts/macOS-ARM" ] && [ -f "artifacts/macOS-ARM/quickcap" ]; then
            cp artifacts/macOS-ARM/quickcap release-assets/quickcap-macos-arm
            chmod +x release-assets/quickcap-macos-arm
            cd release-assets
            tar -czf quickcap-macos-arm.tar.gz quickcap-macos-arm
            cd ..
          fi
          
          echo "Release assets prepared:"
          ls -lh release-assets/

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release-notes.md << EOF
          # Release ${{ steps.tag.outputs.version }}
          
          ## 构建信息
          - **版本**: ${{ steps.tag.outputs.version }}
          - **构建时间**: ${{ steps.build_info.outputs.time }}
          - **构建日期**: ${{ steps.build_info.outputs.date }}
          - **提交**: ${{ steps.build_info.outputs.commit }}
          
          ## 平台支持
          - ✅ Windows x64 (MSVC)
          - ✅ macOS Intel (x86_64)
          - ✅ macOS ARM (Apple Silicon)
          
          ## 下载
          请根据您的系统下载对应的可执行文件：
          - Windows: \`quickcap-windows-x64.exe\` 或 \`quickcap-windows-x64.zip\`
          - macOS Intel: \`quickcap-macos-intel\` 或 \`quickcap-macos-intel.tar.gz\`
          - macOS ARM: \`quickcap-macos-arm\` 或 \`quickcap-macos-arm.tar.gz\`
          
          ## 安装说明
          1. 下载对应平台的文件
          2. 解压（如需要）
          3. 运行可执行文件
          
          ---
          *此版本由 GitHub Actions 自动构建*
          EOF
          cat release-notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.version }}
          body_path: release-notes.md
          files: release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

